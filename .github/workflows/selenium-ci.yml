name: Manual Test - Single Login Flow (Dynamic Wait)

on:
  # TRIGER: Only run when manually triggered on GitHub
  workflow_dispatch: 

jobs:
  run-superadmin-login:
    runs-on: ubuntu-latest

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      - name: 3. Install Required Utilities (Chrome and Netcat)
        # We need netcat (nc) for the dynamic port check
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable netcat-openbsd

      - name: 4. Build Project and Dependencies
        run: mvn clean install -DskipTests

      # ----------------------------------------------------------------------
      # PERSISTENT BROWSER EXECUTION WITH DYNAMIC WAIT
      # ----------------------------------------------------------------------
      - name: 5. Launch Browser & Wait for Port 53478
        run: |
          echo "Starting Base.LaunchSessionBrowser in the background..."
          # Start the browser process detached from the current shell
          nohup java -cp target/classes:$(echo ~/.m2/repository/org/seleniumhq/selenium/*/*/*/*.jar | tr ' ' ':') Base.LaunchSessionBrowser > browser.log 2>&1 &
          
          # Dynamic Wait Logic: Check port until open (max 60 seconds)
          echo "Waiting dynamically for port 53478 to open..."
          
          TIMEOUT_SECONDS=60
          COUNTER=0
          
          # Loop until 'nc' succeeds (exit code 0)
          until nc -z localhost 53478; do
            if [ $COUNTER -ge $TIMEOUT_SECONDS ]; then
              echo "❌ ERROR: Browser port 53478 did not open within $TIMEOUT_SECONDS seconds. Failing build."
              exit 1 # Fail the step if timeout is reached
            fi
            echo "Port not ready yet, waiting 1 second... ($COUNTER/$TIMEOUT_SECONDS)"
            sleep 1
            COUNTER=$((COUNTER + 1))
          done
          
          echo "✅ Port 53478 is now open and ready for tests."

      # ----------------------------------------------------------------------
      # TEST EXECUTION
      # ----------------------------------------------------------------------
      - name: 6. Run TestNG Suite (SuperAdminLoginTest only)
        run: |
          echo "Executing single TestNG class, attaching via Base.Launch"
          # Ensure you use the name of your specific XML file here
          mvn test -Dsurefire.suiteXmlFiles=testng.xml

      # ----------------------------------------------------------------------
      # CLEANUP (GUARANTEED)
      # ----------------------------------------------------------------------
      - name: 7. Cleanup Persistent Processes
        if: always()
        run: |
          echo "Killing background processes to free port 53478..."
          pkill -f "Base.LaunchSessionBrowser"
          pkill -f "chromedriver"
          echo "Cleanup complete."