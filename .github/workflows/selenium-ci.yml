name: Persistent Selenium CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Allows manual trigger

jobs:
  run-persistent-tests:
    runs-on: ubuntu-latest # Use a Linux environment for easier background execution

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      - name: 2. Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven' # Change to 'gradle' if using Gradle

      - name: 3. Install Google Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      - name: 4. Build Project and Dependencies
        run: mvn clean install -DskipTests # Use 'gradle clean build -x test' for Gradle

      # ----------------------------------------------------------------------
      # PERSISTENT BROWSER EXECUTION
      # ----------------------------------------------------------------------
      - name: 5. Launch Persistent Browser (Base.LaunchSessionBrowser)
        # The 'nohup ... &' is CRUCIAL for background execution.
        run: |
          echo "Starting Base.LaunchSessionBrowser in the background..."
          # Command line execution using the compiled classes and dependencies
          # Replace 'target/classes' with your compiled output path if different
          nohup java -cp target/classes:$(echo ~/.m2/repository/org/seleniumhq/selenium/*/*/*/*.jar | tr ' ' ':') Base.LaunchSessionBrowser > browser.log 2>&1 &
          
          echo "Waiting 10 seconds for Chrome to open on port 53478..."
          sleep 10
        
      # ----------------------------------------------------------------------
      # TEST EXECUTION
      # ----------------------------------------------------------------------
      - name: 6. Run TestNG Suite (Attaching to session)
        # This step runs your TestNG tests. Base.Launch.java will attach to the session started above.
        run: |
          echo "Executing TestNG, which should attach via Base.Launch"
          # Ensure you use the correct command line runner for TestNG
          mvn test -Dsurefire.suiteXmlFiles=testng.xml
          
      # ----------------------------------------------------------------------
      # CLEANUP (GUARANTEED)
      # ----------------------------------------------------------------------
      - name: 7. Cleanup Persistent Processes
        if: always() # CRUCIAL: Runs even if the previous test step fails
        run: |
          echo "Killing background processes to free port 53478..."
          # Kill the persistent Java process using its new class name
          pkill -f "Base.LaunchSessionBrowser"
          # Kill the ChromeDriver process
          pkill -f "chromedriver"
          
          echo "Cleanup complete."